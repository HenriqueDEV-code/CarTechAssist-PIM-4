@page "/Chamados/Detalhes/{id:long}"
@model CarTechAssist.Web.Pages.Chamados.DetalhesModel
@{
    ViewData["Title"] = "Detalhes do Chamado";
}

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-0">
                    <i class="bi bi-list-ul text-success"></i> Detalhes do Chamado
                </h1>
                @if (Model.Chamado != null)
                {
                    <p class="text-muted mb-0">@Model.Chamado.Numero - @Model.Chamado.Titulo</p>
                }
            </div>
            <div>
                <a href="/Chamados" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Voltar
                </a>
            </div>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger" role="alert">
        @Model.ErrorMessage
    </div>
}

@if (Model.Chamado != null)
{
    <div class="row">
        <!-- Informa√ß√µes do Chamado -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle"></i> Informa√ß√µes do Chamado
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>N√∫mero:</strong> @Model.Chamado.Numero
                        </div>
                        <div class="col-md-6 mb-3 text-md-end">
                            <strong>Data de Cria√ß√£o:</strong> @Model.Chamado.DataCriacao.ToString("dd/MM/yyyy HH:mm")
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>T√≠tulo:</strong> @Model.Chamado.Titulo
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Usu√°rio que abriu o chamado:</strong> @(Model.SolicitanteNome ?? "N√£o informado")
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Status:</strong>
                            @if (Model.TipoUsuarioId == 2 || Model.TipoUsuarioId == 3)
                            {
                                <select id="statusSelect" class="form-select d-inline-block ms-2" style="width: auto; display: inline-block !important;">
                                    @foreach (var status in Model.GetStatusList())
                                    {
                                        @if (status.Value == Model.Chamado.StatusId)
                                        {
                                            <option value="@status.Value" selected>@status.Name</option>
                                        }
                                        else
                                        {
                                            <option value="@status.Value">@status.Name</option>
                                        }
                                    }
                                </select>
                            }
                            else
                            {
                                <span id="statusBadge" class="badge @Model.GetStatusBadgeClass(Model.Chamado.StatusId) ms-2">
                                    @Model.Chamado.StatusNome
                                </span>
                            }
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Prioridade:</strong>
                            <span class="badge @Model.GetPrioridadeBadgeClass(Model.Chamado.PrioridadeId) ms-2">
                                @Model.Chamado.PrioridadeNome
                            </span>
                        </div>
                        @if (!string.IsNullOrEmpty(Model.Chamado.Descricao))
                        {
                            <div class="col-12 mb-3">
                                <strong>Descri√ß√£o:</strong>
                                <p class="mt-2">@Model.Chamado.Descricao</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensagens / Chat -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-chat-dots"></i> Mensagens / Chat
                    </h5>
                </div>
                <div class="card-body">
                    <div id="chatMessages" style="min-height: 300px; max-height: 500px; overflow-y: auto; background: var(--bg-secondary); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        @if (Model.Interacoes != null && Model.Interacoes.Any())
                        {
                            @foreach (var interacao in Model.Interacoes.OrderBy(i => i.DataCriacao))
                            {
                                <div class="mb-3 p-3" style="background: var(--bg-primary); border-radius: 8px; border-left: 3px solid var(--accent-green);">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <strong style="color: var(--accent-green);">
                                                @(string.IsNullOrEmpty(interacao.AutorNome) ? "Usu√°rio" : interacao.AutorNome)
                                            </strong>
                                            @if (interacao.IA_Gerada)
                                            {
                                                <span class="badge bg-info ms-2">IA</span>
                                            }
                                        </div>
                                        <small class="text-muted">@interacao.DataCriacao.ToString("dd/MM/yyyy HH:mm")</small>
                                    </div>
                                    @if (!string.IsNullOrEmpty(interacao.Mensagem))
                                    {
                                        <p class="mb-0" style="white-space: pre-wrap;">@interacao.Mensagem</p>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-chat-left-text" style="font-size: 3rem; opacity: 0.3;"></i>
                                <p class="mt-3">Nenhuma mensagem ainda. Inicie a conversa!</p>
                            </div>
                        }
                    </div>
                    <div class="d-flex gap-2">
                        <div class="flex-grow-1 position-relative">
                            <input type="text" id="mensagemInput" class="form-control" placeholder="Digite sua mensagem..." />
                            <div id="mensagemBloqueadaInfo" class="alert alert-info mt-2 mb-0" style="display: none; background: var(--bg-secondary); border-color: var(--accent-green);">
                                <i class="bi bi-info-circle me-2" style="color: var(--accent-green);"></i>
                                <span style="color: var(--text-primary);">Este chamado est√° finalizado. Por favor, crie um novo chamado para continuar o atendimento.</span>
                                <a href="/Chamados/Novo" class="btn btn-sm btn-primary ms-2" style="background: var(--accent-green); border-color: var(--accent-green);">
                                    <i class="bi bi-plus-circle"></i> Criar Novo Chamado
                                </a>
                            </div>
                        </div>
                        <button type="button" id="btnEnviarMensagem" class="btn btn-primary">
                            <i class="bi bi-send"></i> Enviar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Anexos -->
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-paperclip"></i> Anexos
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex gap-2 align-items-center flex-wrap">
                            <input type="file" id="arquivoInput" class="form-control" style="max-width: 300px;" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.txt,.xls,.xlsx,.zip,.rar" />
                            <span id="arquivoNome" class="text-muted">Nenhum arquivo escolhido</span>
                            <button type="button" id="btnEnviarAnexo" class="btn btn-primary ms-auto">
                                <i class="bi bi-upload"></i> Enviar Anexo
                            </button>
                        </div>
                        <small class="text-muted d-block mt-2">
                            Tamanho m√°ximo: 10MB. Formatos permitidos: PDF, DOC, DOCX, JPG, PNG, GIF, TXT, XLS, XLSX, ZIP, RAR
                        </small>
                    </div>
                    <div id="anexosList" style="min-height: 100px;">
                        @if (Model.Anexos != null && Model.Anexos.Any())
                        {
                            <div class="list-group">
                                @foreach (var anexo in Model.Anexos.OrderByDescending(a => a.DataCriacao))
                                {
                                    <div class="list-group-item" style="background: var(--bg-secondary); border-color: var(--border-color);">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="bi bi-file-earmark me-2"></i>
                                                <strong>@anexo.NomeArquivo</strong>
                                                <small class="text-muted ms-2">(@Model.FormatFileSize(anexo.TamanhoBytes))</small>
                                            </div>
                                            <a href="/Chamados/Detalhes/@Model.Chamado.ChamadoId?handler=DownloadAnexo&anexoId=@anexo.AnexoId" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-download"></i> Download
                                            </a>
                                        </div>
                                        <small class="text-muted">Enviado em @anexo.DataCriacao.ToString("dd/MM/yyyy HH:mm")</small>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">Nenhum anexo ainda.</p>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@* Formul√°rio oculto para gerar o anti-forgery token *@
<form method="post" style="display: none;">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
    <script>
        const chamadoId = @(Model.Chamado?.ChamadoId ?? 0);
        const tipoUsuarioId = @(Model.TipoUsuarioId);
        const isCliente = tipoUsuarioId === 1;
        
        // Fun√ß√£o para obter o token anti-forgery
        function getAntiForgeryToken() {
            const tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
            return tokenElement ? tokenElement.value : '';
        }
        
        // Criar um endpoint na pr√≥pria p√°gina para enviar mensagem
        async function enviarMensagem(mensagem) {
            const formData = new FormData();
            formData.append('mensagem', mensagem);
            formData.append('__RequestVerificationToken', getAntiForgeryToken());
            
            const response = await fetch(`/Chamados/Detalhes/${chamadoId}?handler=AdicionarInteracao`, {
                method: 'POST',
                body: formData
            });
            
            return response;
        }
        
        // Criar um endpoint na pr√≥pria p√°gina para enviar anexo
        async function enviarAnexo(arquivo) {
            const formData = new FormData();
            formData.append('arquivo', arquivo);
            formData.append('__RequestVerificationToken', getAntiForgeryToken());
            
            const response = await fetch(`/Chamados/Detalhes/${chamadoId}?handler=UploadAnexo`, {
                method: 'POST',
                body: formData
            });
            
            return response;
        }

        // Fun√ß√£o para adicionar mensagem ao chat dinamicamente
        function adicionarMensagemAoChat(interacao) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;

            // Remove a mensagem de "Nenhuma mensagem ainda" se existir
            const emptyMessage = chatMessages.querySelector('.empty-chat-message');
            if (emptyMessage) {
                emptyMessage.remove();
            }

            // Cria o elemento da mensagem
            const mensagemDiv = document.createElement('div');
            mensagemDiv.className = 'mb-3 p-3 chat-message';
            mensagemDiv.setAttribute('data-interacao-id', interacao.interacaoId);
            mensagemDiv.style.cssText = 'background: var(--bg-primary); border-radius: 8px; border-left: 3px solid var(--accent-green); opacity: 0; transition: opacity 0.3s ease-in;';
            
            const badgeIA = interacao.iaGerada ? '<span class="badge bg-info ms-2">IA</span>' : '';
            
            mensagemDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <strong style="color: var(--accent-green);">${escapeHtml(interacao.autorNome)}</strong>
                        ${badgeIA}
                    </div>
                    <small class="text-muted">${interacao.dataCriacao}</small>
                </div>
                <p class="mb-0" style="white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(interacao.mensagem)}</p>
            `;

            chatMessages.appendChild(mensagemDiv);
            
            // Anima√ß√£o de fade-in
            setTimeout(() => {
                mensagemDiv.style.opacity = '1';
            }, 10);
            
            // Scroll autom√°tico para a √∫ltima mensagem com anima√ß√£o suave
            setTimeout(() => {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }

        // Fun√ß√£o para escapar HTML (prevenir XSS)
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Enviar mensagem
        document.getElementById('btnEnviarMensagem')?.addEventListener('click', async function() {
            const input = document.getElementById('mensagemInput');
            
            // Verificar se o campo est√° desabilitado (chamado finalizado para cliente)
            if (input?.disabled) {
                alert('Este chamado est√° finalizado. Por favor, crie um novo chamado para continuar o atendimento.');
                return;
            }
            
            const mensagem = input?.value?.trim();
            
            if (!mensagem) {
                alert('Por favor, digite uma mensagem.');
                return;
            }

            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Enviando...';
            input.disabled = true;

            try {
                const response = await enviarMensagem(mensagem);

                // Verifica se a resposta √© JSON
                let result;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error(text || `Erro HTTP ${response.status}: ${response.statusText}`);
                }

                // Verifica o status HTTP
                if (!response.ok) {
                    const errorMsg = result?.message || `Erro ${response.status}: ${response.statusText}`;
                    
                    if (response.status === 401) {
                        alert('Sua sess√£o expirou. Por favor, fa√ßa login novamente.');
                        window.location.href = '/Login';
                        return;
                    } else {
                        alert(errorMsg);
                        return;
                    }
                }

                if (result.success && result.interacao) {
                    // Adiciona a mensagem ao chat dinamicamente
                    adicionarMensagemAoChat(result.interacao);
                    // Atualiza o √∫ltimo ID para evitar duplicatas
                    ultimoInteracaoId = Math.max(ultimoInteracaoId, result.interacao.interacaoId);
                    input.value = '';
                    
                    // Se for cliente, acionar o bot para processar a mensagem
                    if (isCliente && !botProcessando) {
                        setTimeout(() => {
                            processarMensagemComIA(mensagem);
                        }, 500);
                    }
                } else {
                    alert(result.message || 'Erro ao enviar mensagem. Tente novamente.');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert(error.message || 'Erro ao enviar mensagem. Tente novamente.');
            } finally {
                // S√≥ reabilitar se o chamado n√£o estiver finalizado
                const deveBloquear = isCliente && statusBloqueados.includes(statusAtual);
                if (!deveBloquear) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-send"></i> Enviar';
                    input.disabled = false;
                    input.focus();
                } else {
                    // Manter desabilitado se o chamado estiver finalizado
                    atualizarEstadoMensagem();
                }
            }
        });

        // Enter para enviar mensagem
        document.getElementById('mensagemInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                // N√£o enviar se o campo estiver desabilitado
                if (!this.disabled) {
                    document.getElementById('btnEnviarMensagem')?.click();
                }
            }
        });

        // ============================================
        // ATUALIZA√á√ÉO AUTOM√ÅTICA DO CHAT E STATUS
        // ============================================
        
        let ultimoInteracaoId = @(Model.Interacoes?.Any() == true ? Model.Interacoes.Max(i => i.InteracaoId) : 0);
        let statusAtual = @(Model.Chamado?.StatusId ?? 1);
        let atualizando = false;
        let intervaloAtualizacao = null;
        let botProcessando = false;
        
        // Status que bloqueiam mensagens para clientes
        const statusBloqueados = [4, 5, 6]; // Resolvido, Fechado, Cancelado
        
        // Fun√ß√£o para verificar e atualizar o estado do campo de mensagem
        function atualizarEstadoMensagem() {
            const mensagemInput = document.getElementById('mensagemInput');
            const btnEnviar = document.getElementById('btnEnviarMensagem');
            const mensagemBloqueadaInfo = document.getElementById('mensagemBloqueadaInfo');
            
            if (!mensagemInput || !btnEnviar) return;
            
            // S√≥ bloqueia se for cliente e o status estiver bloqueado
            const deveBloquear = isCliente && statusBloqueados.includes(statusAtual);
            
            if (deveBloquear) {
                mensagemInput.disabled = true;
                mensagemInput.placeholder = "Este chamado est√° finalizado. Crie um novo chamado para continuar.";
                mensagemInput.style.cursor = 'not-allowed';
                mensagemInput.style.opacity = '0.6';
                btnEnviar.disabled = true;
                btnEnviar.style.cursor = 'not-allowed';
                btnEnviar.style.opacity = '0.6';
                if (mensagemBloqueadaInfo) {
                    mensagemBloqueadaInfo.style.display = 'block';
                }
            } else {
                mensagemInput.disabled = false;
                mensagemInput.placeholder = "Digite sua mensagem...";
                mensagemInput.style.cursor = 'text';
                mensagemInput.style.opacity = '1';
                btnEnviar.disabled = false;
                btnEnviar.style.cursor = 'pointer';
                btnEnviar.style.opacity = '1';
                if (mensagemBloqueadaInfo) {
                    mensagemBloqueadaInfo.style.display = 'none';
                }
            }
        }
        
        // Verificar estado inicial ao carregar a p√°gina
        atualizarEstadoMensagem();

        // Fun√ß√£o para buscar novas mensagens e atualizar status
        async function verificarAtualizacoes() {
            // Evita m√∫ltiplas requisi√ß√µes simult√¢neas
            if (atualizando) return;
            
            atualizando = true;
            
            try {
                const response = await fetch(`/Chamados/Detalhes/${chamadoId}?handler=NovasInteracoes&ultimoInteracaoId=${ultimoInteracaoId}`);
                
                if (!response.ok) {
                    // Se der erro 401, para o polling
                    if (response.status === 401) {
                        console.log('Sess√£o expirada. Parando atualiza√ß√£o autom√°tica.');
                        pararAtualizacao();
                        return;
                    }
                    return;
                }

                const result = await response.json();
                
                if (result.success) {
                    // Adicionar novas mensagens ao chat
                    if (result.interacoes && result.interacoes.length > 0) {
                        result.interacoes.forEach(interacao => {
                            // Verifica se a mensagem j√° n√£o existe (evita duplicatas)
                            const existe = document.querySelector(`[data-interacao-id="${interacao.interacaoId}"]`);
                            if (!existe) {
                                adicionarMensagemAoChat(interacao);
                                ultimoInteracaoId = Math.max(ultimoInteracaoId, interacao.interacaoId);
                            }
                        });
                    }

                    // Atualizar status se mudou
                    if (result.statusId && result.statusId !== statusAtual) {
                        statusAtual = result.statusId;
                        atualizarStatus(result.statusId, result.statusNome);
                    }
                }
            } catch (error) {
                console.error('Erro ao verificar atualiza√ß√µes:', error);
            } finally {
                atualizando = false;
            }
        }

        // Fun√ß√£o para atualizar o status na interface
        function atualizarStatus(novoStatusId, novoStatusNome) {
            const statusSelect = document.getElementById('statusSelect');
            const statusBadge = document.getElementById('statusBadge');
            
            if (statusSelect) {
                // Atualiza o select se existir (t√©cnicos/admins)
                statusSelect.value = novoStatusId;
            } else if (statusBadge) {
                // Atualiza o badge se existir (clientes)
                statusBadge.textContent = novoStatusNome;
                // Atualiza a classe do badge baseado no status
                statusBadge.className = `badge ${getStatusBadgeClass(novoStatusId)} ms-2`;
            }
            
            // Atualizar estado do campo de mensagem quando o status mudar
            statusAtual = novoStatusId;
            atualizarEstadoMensagem();
        }

        // Fun√ß√£o auxiliar para obter a classe do badge do status
        function getStatusBadgeClass(statusId) {
            const classes = {
                1: 'bg-secondary', // Aberto
                2: 'bg-primary',    // Em Andamento
                3: 'bg-warning',   // Em Espera
                4: 'bg-success',    // Resolvido
                5: 'bg-dark',       // Fechado
                6: 'bg-danger'      // Cancelado
            };
            return classes[statusId] || 'bg-secondary';
        }

        // Fun√ß√£o para iniciar atualiza√ß√£o autom√°tica
        function iniciarAtualizacao() {
            // Verifica a cada 3 segundos
            intervaloAtualizacao = setInterval(verificarAtualizacoes, 3000);
            console.log('Atualiza√ß√£o autom√°tica iniciada.');
        }

        // Fun√ß√£o para parar atualiza√ß√£o autom√°tica
        function pararAtualizacao() {
            if (intervaloAtualizacao) {
                clearInterval(intervaloAtualizacao);
                intervaloAtualizacao = null;
                console.log('Atualiza√ß√£o autom√°tica parada.');
            }
        }

        // Fun√ß√£o para processar chamado com IA
        async function processarChamadoComIA() {
            if (botProcessando) {
                console.log('Bot j√° est√° processando, aguardando...');
                return;
            }
            
            console.log('ü§ñ Iniciando processamento do chamado com IA. ChamadoId:', chamadoId, 'isCliente:', isCliente);
            
            botProcessando = true;
            try {
                const formData = new FormData();
                formData.append('__RequestVerificationToken', getAntiForgeryToken());
                
                console.log('Enviando requisi√ß√£o para processar chamado com IA...');
                const response = await fetch(`/Chamados/Detalhes/${chamadoId}?handler=ProcessarChamadoComIA`, {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Resposta recebida. Status:', response.status, 'OK:', response.ok);
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('Resultado do bot:', result);
                    if (result.success) {
                        console.log('‚úÖ Bot processou o chamado com sucesso');
                        // A resposta do bot ser√° adicionada automaticamente pela atualiza√ß√£o peri√≥dica
                    } else {
                        console.warn('‚ö†Ô∏è Bot retornou sucesso=false:', result.message || 'Sem mensagem');
                    }
                } else {
                    const errorText = await response.text();
                    console.error('‚ùå Erro na resposta do servidor:', response.status, errorText);
                }
            } catch (error) {
                console.error('‚ùå Erro ao processar chamado com IA:', error);
            } finally {
                botProcessando = false;
            }
        }

        // Fun√ß√£o para processar mensagem com IA
        async function processarMensagemComIA(mensagem) {
            if (botProcessando || !isCliente || !mensagem) return;
            
            botProcessando = true;
            try {
                const formData = new FormData();
                formData.append('mensagem', mensagem);
                formData.append('__RequestVerificationToken', getAntiForgeryToken());
                
                const response = await fetch(`/Chamados/Detalhes/${chamadoId}?handler=ProcessarMensagemComIA`, {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.message) {
                        // A resposta do bot ser√° adicionada automaticamente pela atualiza√ß√£o peri√≥dica
                        console.log('Bot processou a mensagem com sucesso');
                    }
                }
            } catch (error) {
                console.error('Erro ao processar mensagem com IA:', error);
            } finally {
                botProcessando = false;
            }
        }

        // Verificar se j√° existe resposta do bot
        function temRespostaBot() {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return false;
            const mensagensIA = chatMessages.querySelectorAll('.chat-message');
            for (let msg of mensagensIA) {
                const badgeIA = msg.querySelector('.badge.bg-info');
                if (badgeIA && badgeIA.textContent.includes('IA')) {
                    return true;
                }
            }
            return false;
        }

        // Iniciar atualiza√ß√£o autom√°tica quando a p√°gina carregar
        // Aguarda 2 segundos antes de come√ßar para n√£o sobrecarregar
        setTimeout(() => {
            iniciarAtualizacao();
            
            // Verificar se deve acionar o bot
            // O bot deve processar chamados criados por clientes, independente de quem est√° visualizando
            // O backend vai verificar se o chamado foi criado por um cliente
            console.log('Verificando se deve acionar bot:', {
                chamadoId: chamadoId,
                isCliente: isCliente,
                tipoUsuarioId: tipoUsuarioId,
                temRespostaBot: temRespostaBot()
            });
            
            // S√≥ acionar o bot se:
            // 1. O usu√°rio logado √© Cliente (tipoUsuarioId === 1)
            // 2. O chamado existe
            // 3. Ainda n√£o h√° resposta do bot
            if (chamadoId > 0 && isCliente && !temRespostaBot()) {
                console.log('‚úÖ Acionando bot ap√≥s 3 segundos...');
                setTimeout(() => {
                    processarChamadoComIA();
                }, 3000);
            } else {
                console.log('‚ö†Ô∏è Bot n√£o ser√° acionado:', {
                    chamadoIdValido: chamadoId > 0,
                    isCliente: isCliente,
                    tipoUsuarioId: tipoUsuarioId,
                    jaTemResposta: temRespostaBot()
                });
            }
        }, 2000);

        // Parar atualiza√ß√£o quando a p√°gina for fechada ou o usu√°rio sair
        window.addEventListener('beforeunload', pararAtualizacao);
        
        // Pausar atualiza√ß√£o quando a aba n√£o estiver vis√≠vel (para economizar recursos)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                pararAtualizacao();
            } else {
                iniciarAtualizacao();
            }
        });

        // Upload de anexo
        document.getElementById('arquivoInput')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const nomeSpan = document.getElementById('arquivoNome');
            if (file && nomeSpan) {
                nomeSpan.textContent = file.name;
            } else if (nomeSpan) {
                nomeSpan.textContent = 'Nenhum arquivo escolhido';
            }
        });

        document.getElementById('btnEnviarAnexo')?.addEventListener('click', async function() {
            const input = document.getElementById('arquivoInput');
            const file = input?.files[0];
            
            if (!file) {
                alert('Por favor, selecione um arquivo.');
                return;
            }

            // Validar tamanho (10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('Arquivo muito grande. Tamanho m√°ximo: 10MB');
                return;
            }

            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Enviando...';

            try {
                const response = await enviarAnexo(file);

                if (response.ok || response.redirected) {
                    input.value = '';
                    document.getElementById('arquivoNome').textContent = 'Nenhum arquivo escolhido';
                    location.reload();
                } else {
                    const errorText = await response.text();
                    let errorMessage = 'Erro ao enviar anexo. Tente novamente.';
                    try {
                        const error = JSON.parse(errorText);
                        errorMessage = error.message || errorMessage;
                    } catch {
                        errorMessage = errorText || errorMessage;
                    }
                    alert(errorMessage);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao enviar anexo. Tente novamente.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-upload"></i> Enviar Anexo';
            }
        });

        // Scroll autom√°tico para a √∫ltima mensagem
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Alterar status do chamado
        const statusSelect = document.getElementById('statusSelect');
        if (statusSelect) {
            statusSelect.addEventListener('change', async function() {
                const novoStatus = parseInt(this.value);
                const statusAnterior = statusAtual;
                
                // Se n√£o mudou, n√£o faz nada
                if (novoStatus === statusAnterior) {
                    return;
                }

                // Desabilita o select durante o processamento
                this.disabled = true;
                const valorAnterior = statusAnterior;

                try {
                    const formData = new FormData();
                    formData.append('novoStatus', novoStatus);
                    formData.append('__RequestVerificationToken', getAntiForgeryToken());
                    
                    const response = await fetch(`/Chamados/Detalhes/${chamadoId}?handler=AlterarStatus`, {
                        method: 'POST',
                        body: formData
                    });

                    // Verifica se a resposta √© JSON
                    let result;
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        result = await response.json();
                    } else {
                        const text = await response.text();
                        throw new Error(text || `Erro HTTP ${response.status}: ${response.statusText}`);
                    }

                    // Verifica o status HTTP
                    if (!response.ok) {
                        // Erro HTTP - reverte o select e exibe mensagem
                        this.value = valorAnterior;
                        const errorMsg = result?.message || `Erro ${response.status}: ${response.statusText}`;
                        
                        if (response.status === 401) {
                            alert('Sua sess√£o expirou. Por favor, fa√ßa login novamente.');
                            window.location.href = '/Login';
                            return;
                        } else {
                            alert(errorMsg);
                        }
                        return;
                    }

                    if (result.success) {
                        // Sucesso - atualiza o status localmente e a vari√°vel global
                        statusAtual = novoStatus;
                        const statusNome = this.options[this.selectedIndex].text;
                        atualizarStatus(novoStatus, statusNome);
                        
                        // Feedback visual sutil (opcional)
                        this.style.borderColor = '#28a745';
                        setTimeout(() => {
                            this.style.borderColor = '';
                        }, 1000);
                    } else {
                        // Erro - reverte o select e exibe mensagem
                        this.value = valorAnterior;
                        alert(result.message || 'Erro ao alterar status. Tente novamente.');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    // Reverte para o status anterior
                    this.value = valorAnterior;
                    alert(error.message || 'Erro ao alterar status. Tente novamente.');
                } finally {
                    this.disabled = false;
                }
            });
        }
    </script>
}

