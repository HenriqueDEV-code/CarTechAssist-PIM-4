@page "/Chamados/Detalhes/{id:long}"
@model CarTechAssist.Web.Pages.Chamados.DetalhesModel
@{
    ViewData["Title"] = "Detalhes do Chamado";
}

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-0">
                    <i class="bi bi-list-ul text-success"></i> Detalhes do Chamado
                </h1>
                @if (Model.Chamado != null)
                {
                    <p class="text-muted mb-0">@Model.Chamado.Numero - @Model.Chamado.Titulo</p>
                }
            </div>
            <div>
                <a href="/Chamados" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Voltar
                </a>
            </div>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger" role="alert">
        @Model.ErrorMessage
    </div>
}

@if (Model.Chamado != null)
{
    <div class="row">
        <!-- Informações do Chamado -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-info-circle"></i> Informações do Chamado
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <strong>Número:</strong> @Model.Chamado.Numero
                        </div>
                        <div class="col-md-6 mb-3 text-md-end">
                            <strong>Data de Criação:</strong> @Model.Chamado.DataCriacao.ToString("dd/MM/yyyy HH:mm")
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Título:</strong> @Model.Chamado.Titulo
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Usuário que abriu o chamado:</strong> @(Model.SolicitanteNome ?? "Não informado")
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Status:</strong>
                            @if (Model.TipoUsuarioId == 2 || Model.TipoUsuarioId == 3)
                            {
                                <select id="statusSelect" class="form-select d-inline-block ms-2" style="width: auto; display: inline-block !important;">
                                    @foreach (var status in Model.GetStatusList())
                                    {
                                        @if (status.Value == Model.Chamado.StatusId)
                                        {
                                            <option value="@status.Value" selected>@status.Name</option>
                                        }
                                        else
                                        {
                                            <option value="@status.Value">@status.Name</option>
                                        }
                                    }
                                </select>
                            }
                            else
                            {
                                <span id="statusBadge" class="badge @Model.GetStatusBadgeClass(Model.Chamado.StatusId) ms-2">
                                    @Model.Chamado.StatusNome
                                </span>
                            }
                        </div>
                        <div class="col-md-6 mb-3">
                            <strong>Prioridade:</strong>
                            <span class="badge @Model.GetPrioridadeBadgeClass(Model.Chamado.PrioridadeId) ms-2">
                                @Model.Chamado.PrioridadeNome
                            </span>
                        </div>
                        @if (!string.IsNullOrEmpty(Model.Chamado.Descricao))
                        {
                            <div class="col-12 mb-3">
                                <strong>Descrição:</strong>
                                <p class="mt-2">@Model.Chamado.Descricao</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Mensagens / Chat -->
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-chat-dots"></i> Mensagens / Chat
                    </h5>
                </div>
                <div class="card-body">
                    <div id="chatMessages" style="min-height: 300px; max-height: 500px; overflow-y: auto; background: var(--bg-secondary); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                        @if (Model.Interacoes != null && Model.Interacoes.Any())
                        {
                            @foreach (var interacao in Model.Interacoes.OrderBy(i => i.DataCriacao))
                            {
                                <div class="mb-3 p-3" style="background: var(--bg-primary); border-radius: 8px; border-left: 3px solid var(--accent-green);">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div>
                                            <strong style="color: var(--accent-green);">
                                                @(string.IsNullOrEmpty(interacao.AutorNome) ? "Usuário" : interacao.AutorNome)
                                            </strong>
                                            @if (interacao.IA_Gerada)
                                            {
                                                <span class="badge bg-info ms-2">IA</span>
                                            }
                                        </div>
                                        <small class="text-muted">@interacao.DataCriacao.ToString("dd/MM/yyyy HH:mm")</small>
                                    </div>
                                    @if (!string.IsNullOrEmpty(interacao.Mensagem))
                                    {
                                        <p class="mb-0" style="white-space: pre-wrap;">@interacao.Mensagem</p>
                                    }
                                </div>
                            }
                        }
                        else
                        {
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-chat-left-text" style="font-size: 3rem; opacity: 0.3;"></i>
                                <p class="mt-3">Nenhuma mensagem ainda. Inicie a conversa!</p>
                            </div>
                        }
                    </div>
                    <div class="d-flex gap-2">
                        <input type="text" id="mensagemInput" class="form-control" placeholder="Digite sua mensagem..." />
                        <button type="button" id="btnEnviarMensagem" class="btn btn-primary">
                            <i class="bi bi-send"></i> Enviar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Anexos -->
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-paperclip"></i> Anexos
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="d-flex gap-2 align-items-center flex-wrap">
                            <input type="file" id="arquivoInput" class="form-control" style="max-width: 300px;" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.txt,.xls,.xlsx,.zip,.rar" />
                            <span id="arquivoNome" class="text-muted">Nenhum arquivo escolhido</span>
                            <button type="button" id="btnEnviarAnexo" class="btn btn-primary ms-auto">
                                <i class="bi bi-upload"></i> Enviar Anexo
                            </button>
                        </div>
                        <small class="text-muted d-block mt-2">
                            Tamanho máximo: 10MB. Formatos permitidos: PDF, DOC, DOCX, JPG, PNG, GIF, TXT, XLS, XLSX, ZIP, RAR
                        </small>
                    </div>
                    <div id="anexosList" style="min-height: 100px;">
                        @if (Model.Anexos != null && Model.Anexos.Any())
                        {
                            <div class="list-group">
                                @foreach (var anexo in Model.Anexos.OrderByDescending(a => a.DataCriacao))
                                {
                                    <div class="list-group-item" style="background: var(--bg-secondary); border-color: var(--border-color);">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div>
                                                <i class="bi bi-file-earmark me-2"></i>
                                                <strong>@anexo.NomeArquivo</strong>
                                                <small class="text-muted ms-2">(@Model.FormatFileSize(anexo.TamanhoBytes))</small>
                                            </div>
                                            <a href="/Chamados/Detalhes/@Model.Chamado.ChamadoId?handler=DownloadAnexo&anexoId=@anexo.AnexoId" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-download"></i> Download
                                            </a>
                                        </div>
                                        <small class="text-muted">Enviado em @anexo.DataCriacao.ToString("dd/MM/yyyy HH:mm")</small>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">Nenhum anexo ainda.</p>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@* Formulário oculto para gerar o anti-forgery token *@
<form method="post" style="display: none;">
    @Html.AntiForgeryToken()
</form>

@section Scripts {
    <script>
        const chamadoId = @(Model.Chamado?.ChamadoId ?? 0);
        
        // Função para obter o token anti-forgery
        function getAntiForgeryToken() {
            const tokenElement = document.querySelector('input[name="__RequestVerificationToken"]');
            return tokenElement ? tokenElement.value : '';
        }
        
        // Criar um endpoint na própria página para enviar mensagem
        async function enviarMensagem(mensagem) {
            const formData = new FormData();
            formData.append('mensagem', mensagem);
            formData.append('__RequestVerificationToken', getAntiForgeryToken());
            
            const response = await fetch(`/Chamados/Detalhes/${chamadoId}?handler=AdicionarInteracao`, {
                method: 'POST',
                body: formData
            });
            
            return response;
        }
        
        // Criar um endpoint na própria página para enviar anexo
        async function enviarAnexo(arquivo) {
            const formData = new FormData();
            formData.append('arquivo', arquivo);
            formData.append('__RequestVerificationToken', getAntiForgeryToken());
            
            const response = await fetch(`/Chamados/Detalhes/${chamadoId}?handler=UploadAnexo`, {
                method: 'POST',
                body: formData
            });
            
            return response;
        }

        // Função para adicionar mensagem ao chat dinamicamente
        function adicionarMensagemAoChat(interacao) {
            const chatMessages = document.getElementById('chatMessages');
            if (!chatMessages) return;

            // Remove a mensagem de "Nenhuma mensagem ainda" se existir
            const emptyMessage = chatMessages.querySelector('.empty-chat-message');
            if (emptyMessage) {
                emptyMessage.remove();
            }

            // Cria o elemento da mensagem
            const mensagemDiv = document.createElement('div');
            mensagemDiv.className = 'mb-3 p-3 chat-message';
            mensagemDiv.setAttribute('data-interacao-id', interacao.interacaoId);
            mensagemDiv.style.cssText = 'background: var(--bg-primary); border-radius: 8px; border-left: 3px solid var(--accent-green); opacity: 0; transition: opacity 0.3s ease-in;';
            
            const badgeIA = interacao.iaGerada ? '<span class="badge bg-info ms-2">IA</span>' : '';
            
            mensagemDiv.innerHTML = `
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div>
                        <strong style="color: var(--accent-green);">${escapeHtml(interacao.autorNome)}</strong>
                        ${badgeIA}
                    </div>
                    <small class="text-muted">${interacao.dataCriacao}</small>
                </div>
                <p class="mb-0" style="white-space: pre-wrap; word-wrap: break-word;">${escapeHtml(interacao.mensagem)}</p>
            `;

            chatMessages.appendChild(mensagemDiv);
            
            // Animação de fade-in
            setTimeout(() => {
                mensagemDiv.style.opacity = '1';
            }, 10);
            
            // Scroll automático para a última mensagem com animação suave
            setTimeout(() => {
                chatMessages.scrollTo({
                    top: chatMessages.scrollHeight,
                    behavior: 'smooth'
                });
            }, 100);
        }

        // Função para escapar HTML (prevenir XSS)
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Enviar mensagem
        document.getElementById('btnEnviarMensagem')?.addEventListener('click', async function() {
            const input = document.getElementById('mensagemInput');
            const mensagem = input?.value?.trim();
            
            if (!mensagem) {
                alert('Por favor, digite uma mensagem.');
                return;
            }

            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Enviando...';
            input.disabled = true;

            try {
                const response = await enviarMensagem(mensagem);

                // Verifica se a resposta é JSON
                let result;
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    result = await response.json();
                } else {
                    const text = await response.text();
                    throw new Error(text || `Erro HTTP ${response.status}: ${response.statusText}`);
                }

                // Verifica o status HTTP
                if (!response.ok) {
                    const errorMsg = result?.message || `Erro ${response.status}: ${response.statusText}`;
                    
                    if (response.status === 401) {
                        alert('Sua sessão expirou. Por favor, faça login novamente.');
                        window.location.href = '/Login';
                        return;
                    } else {
                        alert(errorMsg);
                        return;
                    }
                }

                if (result.success && result.interacao) {
                    // Adiciona a mensagem ao chat dinamicamente
                    adicionarMensagemAoChat(result.interacao);
                    // Atualiza o último ID para evitar duplicatas
                    ultimoInteracaoId = Math.max(ultimoInteracaoId, result.interacao.interacaoId);
                    input.value = '';
                } else {
                    alert(result.message || 'Erro ao enviar mensagem. Tente novamente.');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert(error.message || 'Erro ao enviar mensagem. Tente novamente.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-send"></i> Enviar';
                input.disabled = false;
                input.focus();
            }
        });

        // Enter para enviar mensagem
        document.getElementById('mensagemInput')?.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('btnEnviarMensagem')?.click();
            }
        });

        // ============================================
        // ATUALIZAÇÃO AUTOMÁTICA DO CHAT E STATUS
        // ============================================
        
        let ultimoInteracaoId = @(Model.Interacoes?.Any() == true ? Model.Interacoes.Max(i => i.InteracaoId) : 0);
        let statusAtual = @(Model.Chamado?.StatusId ?? 1);
        let atualizando = false;
        let intervaloAtualizacao = null;

        // Função para buscar novas mensagens e atualizar status
        async function verificarAtualizacoes() {
            // Evita múltiplas requisições simultâneas
            if (atualizando) return;
            
            atualizando = true;
            
            try {
                const response = await fetch(`/Chamados/Detalhes/${chamadoId}?handler=NovasInteracoes&ultimoInteracaoId=${ultimoInteracaoId}`);
                
                if (!response.ok) {
                    // Se der erro 401, para o polling
                    if (response.status === 401) {
                        console.log('Sessão expirada. Parando atualização automática.');
                        pararAtualizacao();
                        return;
                    }
                    return;
                }

                const result = await response.json();
                
                if (result.success) {
                    // Adicionar novas mensagens ao chat
                    if (result.interacoes && result.interacoes.length > 0) {
                        result.interacoes.forEach(interacao => {
                            // Verifica se a mensagem já não existe (evita duplicatas)
                            const existe = document.querySelector(`[data-interacao-id="${interacao.interacaoId}"]`);
                            if (!existe) {
                                adicionarMensagemAoChat(interacao);
                                ultimoInteracaoId = Math.max(ultimoInteracaoId, interacao.interacaoId);
                            }
                        });
                    }

                    // Atualizar status se mudou
                    if (result.statusId && result.statusId !== statusAtual) {
                        statusAtual = result.statusId;
                        atualizarStatus(result.statusId, result.statusNome);
                    }
                }
            } catch (error) {
                console.error('Erro ao verificar atualizações:', error);
            } finally {
                atualizando = false;
            }
        }

        // Função para atualizar o status na interface
        function atualizarStatus(novoStatusId, novoStatusNome) {
            const statusSelect = document.getElementById('statusSelect');
            const statusBadge = document.getElementById('statusBadge');
            
            if (statusSelect) {
                // Atualiza o select se existir (técnicos/admins)
                statusSelect.value = novoStatusId;
            } else if (statusBadge) {
                // Atualiza o badge se existir (clientes)
                statusBadge.textContent = novoStatusNome;
                // Atualiza a classe do badge baseado no status
                statusBadge.className = `badge ${getStatusBadgeClass(novoStatusId)} ms-2`;
            }
        }

        // Função auxiliar para obter a classe do badge do status
        function getStatusBadgeClass(statusId) {
            const classes = {
                1: 'bg-secondary', // Aberto
                2: 'bg-primary',    // Em Andamento
                3: 'bg-warning',   // Em Espera
                4: 'bg-success',    // Resolvido
                5: 'bg-dark',       // Fechado
                6: 'bg-danger'      // Cancelado
            };
            return classes[statusId] || 'bg-secondary';
        }

        // Função para iniciar atualização automática
        function iniciarAtualizacao() {
            // Verifica a cada 3 segundos
            intervaloAtualizacao = setInterval(verificarAtualizacoes, 3000);
            console.log('Atualização automática iniciada.');
        }

        // Função para parar atualização automática
        function pararAtualizacao() {
            if (intervaloAtualizacao) {
                clearInterval(intervaloAtualizacao);
                intervaloAtualizacao = null;
                console.log('Atualização automática parada.');
            }
        }

        // Iniciar atualização automática quando a página carregar
        // Aguarda 2 segundos antes de começar para não sobrecarregar
        setTimeout(() => {
            iniciarAtualizacao();
        }, 2000);

        // Parar atualização quando a página for fechada ou o usuário sair
        window.addEventListener('beforeunload', pararAtualizacao);
        
        // Pausar atualização quando a aba não estiver visível (para economizar recursos)
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                pararAtualizacao();
            } else {
                iniciarAtualizacao();
            }
        });

        // Upload de anexo
        document.getElementById('arquivoInput')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const nomeSpan = document.getElementById('arquivoNome');
            if (file && nomeSpan) {
                nomeSpan.textContent = file.name;
            } else if (nomeSpan) {
                nomeSpan.textContent = 'Nenhum arquivo escolhido';
            }
        });

        document.getElementById('btnEnviarAnexo')?.addEventListener('click', async function() {
            const input = document.getElementById('arquivoInput');
            const file = input?.files[0];
            
            if (!file) {
                alert('Por favor, selecione um arquivo.');
                return;
            }

            // Validar tamanho (10MB)
            if (file.size > 10 * 1024 * 1024) {
                alert('Arquivo muito grande. Tamanho máximo: 10MB');
                return;
            }

            const btn = this;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Enviando...';

            try {
                const response = await enviarAnexo(file);

                if (response.ok || response.redirected) {
                    input.value = '';
                    document.getElementById('arquivoNome').textContent = 'Nenhum arquivo escolhido';
                    location.reload();
                } else {
                    const errorText = await response.text();
                    let errorMessage = 'Erro ao enviar anexo. Tente novamente.';
                    try {
                        const error = JSON.parse(errorText);
                        errorMessage = error.message || errorMessage;
                    } catch {
                        errorMessage = errorText || errorMessage;
                    }
                    alert(errorMessage);
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao enviar anexo. Tente novamente.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-upload"></i> Enviar Anexo';
            }
        });

        // Scroll automático para a última mensagem
        const chatMessages = document.getElementById('chatMessages');
        if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Alterar status do chamado
        const statusSelect = document.getElementById('statusSelect');
        if (statusSelect) {
            statusSelect.addEventListener('change', async function() {
                const novoStatus = parseInt(this.value);
                const statusAnterior = @(Model.Chamado?.StatusId ?? 1);
                
                // Se não mudou, não faz nada
                if (novoStatus === statusAnterior) {
                    return;
                }

                // Confirmação antes de alterar
                const statusNome = this.options[this.selectedIndex].text;
                if (!confirm(`Deseja realmente alterar o status para "${statusNome}"?`)) {
                    // Reverte para o status anterior
                    this.value = statusAnterior;
                    return;
                }

                // Desabilita o select durante o processamento
                this.disabled = true;
                const selectOriginal = this.innerHTML;

                try {
                    const formData = new FormData();
                    formData.append('novoStatus', novoStatus);
                    formData.append('__RequestVerificationToken', getAntiForgeryToken());
                    
                    const response = await fetch(`/Chamados/Detalhes/${chamadoId}?handler=AlterarStatus`, {
                        method: 'POST',
                        body: formData
                    });

                    // Verifica se a resposta é JSON
                    let result;
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        result = await response.json();
                    } else {
                        const text = await response.text();
                        throw new Error(text || `Erro HTTP ${response.status}: ${response.statusText}`);
                    }

                    // Verifica o status HTTP
                    if (!response.ok) {
                        // Erro HTTP - reverte o select e exibe mensagem
                        this.value = statusAnterior;
                        const errorMsg = result?.message || `Erro ${response.status}: ${response.statusText}`;
                        
                        if (response.status === 401) {
                            alert('Sua sessão expirou. Por favor, faça login novamente.');
                            // Opcional: redirecionar para login
                            // window.location.href = '/Login';
                        } else {
                            alert(errorMsg);
                        }
                        return;
                    }

                    if (result.success) {
                        // Sucesso - recarrega a página para atualizar os dados
                        location.reload();
                    } else {
                        // Erro - reverte o select e exibe mensagem
                        this.value = statusAnterior;
                        alert(result.message || 'Erro ao alterar status. Tente novamente.');
                    }
                } catch (error) {
                    console.error('Erro:', error);
                    // Reverte para o status anterior
                    this.value = statusAnterior;
                    alert(error.message || 'Erro ao alterar status. Tente novamente.');
                } finally {
                    this.disabled = false;
                }
            });
        }
    </script>
}

