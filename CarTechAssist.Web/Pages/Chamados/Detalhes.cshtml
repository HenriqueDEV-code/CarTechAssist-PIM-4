@page "/Chamados/Detalhes/{id:long}"
@model CarTechAssist.Web.Pages.Chamados.DetalhesModel
@{
    ViewData["Title"] = "Detalhes do Chamado";
}

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-0">
                    <i class="bi bi-ticket-detailed text-success"></i> Detalhes do Chamado
                </h1>
                @if (Model.Chamado != null)
                {
                    <p class="text-muted">@Model.Chamado.Numero - @Model.Chamado.Titulo</p>
                }
            </div>
            <div>
                <a href="/Chamados" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Voltar
                </a>
            </div>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(Model.SuccessMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @Model.SuccessMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger" role="alert">
        @Model.ErrorMessage
    </div>
}

@if (Model.Chamado != null)
{
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Informações do Chamado</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Número:</strong> @Model.Chamado.Numero</p>
                            <p><strong>Título:</strong> @Model.Chamado.Titulo</p>
                            <p><strong>Status:</strong> 
                                <span class="badge bg-info">@Model.GetStatusNome(Model.Chamado.StatusId)</span>
                            </p>
                            <p><strong>Prioridade:</strong> 
                                <span class="badge bg-warning">@Model.GetPrioridadeNome(Model.Chamado.PrioridadeId)</span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Data de Criação:</strong> @Model.Chamado.DataCriacao.ToString("dd/MM/yyyy HH:mm")</p>
                            @if (Model.Chamado.DataAtualizacao.HasValue)
                            {
                                <p><strong>Última Atualização:</strong> @Model.Chamado.DataAtualizacao.Value.ToString("dd/MM/yyyy HH:mm")</p>
                            }
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.Chamado.Descricao))
                    {
                        <hr />
                        <p><strong>Descrição:</strong></p>
                        <p>@Model.Chamado.Descricao</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-chat-dots"></i> Mensagens / Chat
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chat-messages mb-4" style="max-height: 500px; overflow-y: auto; padding: 15px; background: #1a1a1a; border-radius: 8px;">
                        @if (Model.Interacoes != null && Model.Interacoes.Any())
                        {
                            @foreach (var interacao in Model.Interacoes.OrderBy(i => i.DataCriacao))
                            {
                                var isMe = interacao.AutorUsuarioId == Model.UsuarioId;
                                var tipoUsuarioNome = Model.GetTipoUsuarioNome(interacao.AutorTipoUsuarioId);
                                var autorNome = !string.IsNullOrEmpty(interacao.AutorNome) ? interacao.AutorNome : tipoUsuarioNome;
                                
                                <div class="message mb-3 @(isMe ? "text-end" : "")">
                                    <div class="d-inline-block p-3 rounded" style="background: @(isMe ? "#4CAF50" : "#282c34"); max-width: 70%;">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="fw-bold">@autorNome</small>
                                            @if (interacao.IA_Gerada)
                                            {
                                                <span class="badge bg-secondary">IA</span>
                                            }
                                        </div>
                                        <p class="mb-1">@interacao.Mensagem</p>
                                        <small class="text-muted">@interacao.DataCriacao.ToString("dd/MM/yyyy HH:mm")</small>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <p class="text-muted text-center">Nenhuma mensagem ainda. Inicie a conversa!</p>
                        }
                    </div>

                    <form method="post">
                        <div class="input-group">
                            <input type="text" asp-for="NovaMensagem" class="form-control" placeholder="Digite sua mensagem..." />
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-send"></i> Enviar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-paperclip"></i> Anexos
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" asp-page-handler="Upload" enctype="multipart/form-data" class="mb-3">
                        <div class="input-group">
                            <input type="file" asp-for="ArquivoUpload" class="form-control" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.txt,.xls,.xlsx,.zip,.rar" />
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-upload"></i> Enviar Anexo
                            </button>
                        </div>
                        <small class="text-muted">Tamanho máximo: 10MB. Formatos permitidos: PDF, DOC, DOCX, JPG, PNG, GIF, TXT, XLS, XLSX, ZIP, RAR</small>
                    </form>

                    @if (Model.Anexos != null && Model.Anexos.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Nome do Arquivo</th>
                                        <th>Tipo</th>
                                        <th>Tamanho</th>
                                        <th>Data</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var anexo in Model.Anexos)
                                    {
                                        <tr>
                                            <td>@anexo.NomeArquivo</td>
                                            <td><span class="badge bg-secondary">@(anexo.ContentType ?? "N/A")</span></td>
                                            <td>@Model.FormatarTamanho(anexo.TamanhoBytes ?? 0)</td>
                                            <td>@anexo.DataCriacao.ToString("dd/MM/yyyy HH:mm")</td>
                                            <td>
                                                <a href="/api/chamados/@(Model.Chamado?.ChamadoId ?? 0)/anexos/@anexo.AnexoId" class="btn btn-sm btn-outline-primary" target="_blank">
                                                    <i class="bi bi-download"></i> Download
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">Nenhum anexo ainda.</p>
                    }
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        // Auto-scroll para a última mensagem
        document.addEventListener('DOMContentLoaded', function() {
            var chatMessages = document.querySelector('.chat-messages');
            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        });
    </script>
}

