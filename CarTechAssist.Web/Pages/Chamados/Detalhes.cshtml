@page "/Chamados/Detalhes/{id:long}"
@model CarTechAssist.Web.Pages.Chamados.DetalhesModel
@{
    ViewData["Title"] = "Detalhes do Chamado";
}

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-0">
                    <i class="bi bi-ticket-detailed text-success"></i> Detalhes do Chamado
                </h1>
                @if (Model.Chamado != null)
                {
                    <p class="text-muted">@Model.Chamado.Numero - @Model.Chamado.Titulo</p>
                }
            </div>
            <div>
                <a href="/Chamados" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Voltar
                </a>
            </div>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(Model.SuccessMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @Model.SuccessMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger" role="alert">
        @Model.ErrorMessage
    </div>
}

@if (Model.Chamado != null)
{
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Informações do Chamado</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Número:</strong> @Model.Chamado.Numero</p>
                            <p><strong>Título:</strong> @Model.Chamado.Titulo</p>
                            <p>
                                <strong>Status:</strong>
                                @if (Model.IsTecnico())
                                {
                                    <form method="post" asp-page-handler="AlterarStatus" class="d-inline" id="formAlterarStatus">
                                        @Html.AntiForgeryToken()
                                        <select asp-for="NovoStatus" class="form-select form-select-sm d-inline-block" style="width: auto;" onchange="alterarStatus(this.value)">
                                            <option value="1" selected="@(Model.Chamado.StatusId == 1)">Aberto</option>
                                            <option value="2" selected="@(Model.Chamado.StatusId == 2)">Em Andamento</option>
                                            <option value="3" selected="@(Model.Chamado.StatusId == 3)">Aguardando Usuário</option>
                                            <option value="4" selected="@(Model.Chamado.StatusId == 4)">Resolvido</option>
                                            <option value="5" selected="@(Model.Chamado.StatusId == 5)">Fechado</option>
                                            <option value="6" selected="@(Model.Chamado.StatusId == 6)">Cancelado</option>
                                        </select>
                                    </form>
                                    <script>
                                        // Garantir que o select tenha o valor correto ao carregar
                                        document.addEventListener('DOMContentLoaded', function() {
                                            const selectStatus = document.querySelector('#formAlterarStatus select');
                                            if (selectStatus) {
                                                selectStatus.value = '@Model.Chamado.StatusId';
                                            }
                                        });
                                    </script>
                                }
                                else
                                {
                                    <span class="badge bg-info status-badge">@Model.GetStatusNome(Model.Chamado.StatusId)</span>
                                }
                            </p>
                            <p><strong>Prioridade:</strong> 
                                <span class="badge bg-warning">@Model.GetPrioridadeNome(Model.Chamado.PrioridadeId)</span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Data de Criação:</strong> @Model.Chamado.DataCriacao.ToString("dd/MM/yyyy HH:mm")</p>
                            @if (Model.Chamado.DataAtualizacao.HasValue)
                            {
                                <p><strong>Última Atualização:</strong> @Model.Chamado.DataAtualizacao.Value.ToString("dd/MM/yyyy HH:mm")</p>
                            }
                        </div>
                    </div>
                    @if (!string.IsNullOrEmpty(Model.Chamado.Descricao))
                    {
                        <hr />
                        <p><strong>Descrição:</strong></p>
                        <p>@Model.Chamado.Descricao</p>
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-chat-dots"></i> Mensagens / Chat
                    </h5>
                </div>
                <div class="card-body">
                    <div class="chat-messages mb-4" style="max-height: 500px; overflow-y: auto; padding: 15px; background: #1a1a1a; border-radius: 8px;">
                        @if (Model.Interacoes != null && Model.Interacoes.Any())
                        {
                            @foreach (var interacao in Model.Interacoes.OrderBy(i => i.DataCriacao))
                            {
                                var isMe = interacao.AutorUsuarioId == Model.UsuarioId;
                                var tipoUsuarioNome = Model.GetTipoUsuarioNome(interacao.AutorTipoUsuarioId);
                                var autorNome = !string.IsNullOrEmpty(interacao.AutorNome) ? interacao.AutorNome : tipoUsuarioNome;
                                
                                <div class="message mb-3 @(isMe ? "text-end" : "")" data-interacao-id="@interacao.InteracaoId">
                                    <div class="d-inline-block p-3 rounded" style="background: @(isMe ? "#4CAF50" : "#282c34"); max-width: 70%;">
                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                            <small class="fw-bold">@autorNome</small>
                                            @if (interacao.IA_Gerada)
                                            {
                                                <span class="badge bg-secondary">IA</span>
                                            }
                                        </div>
                                        <p class="mb-1">@interacao.Mensagem</p>
                                        <small class="text-muted">@interacao.DataCriacao.ToString("dd/MM/yyyy HH:mm")</small>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <p class="text-muted text-center">Nenhuma mensagem ainda. Inicie a conversa!</p>
                        }
                    </div>

                    <form method="post" id="formMensagem" onsubmit="return enviarMensagem(event)">
                        @Html.AntiForgeryToken()
                        <div class="input-group">
                            <input type="text" asp-for="NovaMensagem" id="inputMensagem" class="form-control" placeholder="Digite sua mensagem..." required />
                            <button type="submit" class="btn btn-primary" id="btnEnviar">
                                <i class="bi bi-send"></i> Enviar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-paperclip"></i> Anexos
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" asp-page-handler="Upload" enctype="multipart/form-data" class="mb-3">
                        <div class="input-group">
                            <input type="file" asp-for="ArquivoUpload" class="form-control" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.txt,.xls,.xlsx,.zip,.rar" />
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-upload"></i> Enviar Anexo
                            </button>
                        </div>
                        <small class="text-muted">Tamanho máximo: 10MB. Formatos permitidos: PDF, DOC, DOCX, JPG, PNG, GIF, TXT, XLS, XLSX, ZIP, RAR</small>
                    </form>

                    @if (Model.Anexos != null && Model.Anexos.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Nome do Arquivo</th>
                                        <th>Tipo</th>
                                        <th>Tamanho</th>
                                        <th>Data</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var anexo in Model.Anexos)
                                    {
                                        <tr>
                                            <td>@anexo.NomeArquivo</td>
                                            <td><span class="badge bg-secondary">@(anexo.ContentType ?? "N/A")</span></td>
                                            <td>@Model.FormatarTamanho(anexo.TamanhoBytes ?? 0)</td>
                                            <td>@anexo.DataCriacao.ToString("dd/MM/yyyy HH:mm")</td>
                                            <td>
                                                <a href="/api/chamados/@(Model.Chamado?.ChamadoId ?? 0)/anexos/@anexo.AnexoId" class="btn btn-sm btn-outline-primary" target="_blank">
                                                    <i class="bi bi-download"></i> Download
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">Nenhum anexo ainda.</p>
                    }
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        let chamadoId = @(Model.Chamado?.ChamadoId ?? 0);
        let ultimaInteracaoId = @(Model.Interacoes?.Any() == true ? Model.Interacoes.Max(i => i.InteracaoId) : 0);
        let pollingAtivo = true;

        // Auto-scroll para a última mensagem
        document.addEventListener('DOMContentLoaded', function() {
            var chatMessages = document.querySelector('.chat-messages');
            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            // Iniciar polling para atualizar mensagens e status
            iniciarPolling();
        });

        // Função para alterar status via AJAX
        async function alterarStatus(novoStatus) {
            try {
                // Desabilitar o select durante o envio
                const selectStatus = document.querySelector('#formAlterarStatus select');
                if (selectStatus) {
                    selectStatus.disabled = true;
                }

                const formData = new FormData();
                formData.append('NovoStatus', novoStatus);
                formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]')?.value || '');

                const response = await fetch(`/Chamados/Detalhes/${chamadoId}?handler=AlterarStatus`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok || response.redirected) {
                    // Aguardar um pouco para garantir que o status foi salvo no banco
                    await new Promise(resolve => setTimeout(resolve, 500));
                    // Recarregar página para mostrar novo status
                    location.reload();
                } else {
                    alert('Erro ao alterar status. Tente novamente.');
                    if (selectStatus) {
                        selectStatus.disabled = false;
                        // Reverter para o status anterior
                        selectStatus.value = '@Model.Chamado.StatusId';
                    }
                }
            } catch (error) {
                console.error('Erro ao alterar status:', error);
                alert('Erro ao alterar status. Tente novamente.');
                const selectStatus = document.querySelector('#formAlterarStatus select');
                if (selectStatus) {
                    selectStatus.disabled = false;
                    // Reverter para o status anterior
                    selectStatus.value = '@Model.Chamado.StatusId';
                }
            }
        }

        // Função para enviar mensagem via AJAX
        async function enviarMensagem(event) {
            event.preventDefault();
            
            const inputMensagem = document.getElementById('inputMensagem');
            const btnEnviar = document.getElementById('btnEnviar');
            const mensagem = inputMensagem.value.trim();
            
            if (!mensagem) {
                return false;
            }

            // Desabilitar botão durante envio
            btnEnviar.disabled = true;
            btnEnviar.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Enviando...';

            try {
                // Usar o formulário POST padrão do Razor Pages
                const form = document.getElementById('formMensagem');
                const formData = new FormData(form);
                
                const response = await fetch(form.action || window.location.href, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    }
                });

                if (response.ok || response.redirected) {
                    // Aguardar um pouco para garantir que a mensagem foi salva no banco
                    await new Promise(resolve => setTimeout(resolve, 500));
                    // Recarregar página para mostrar nova mensagem
                    location.reload();
                } else {
                    alert('Erro ao enviar mensagem. Tente novamente.');
                }
            } catch (error) {
                console.error('Erro ao enviar mensagem:', error);
                alert('Erro ao enviar mensagem. Tente novamente.');
            } finally {
                btnEnviar.disabled = false;
                btnEnviar.innerHTML = '<i class="bi bi-send"></i> Enviar';
            }

            return false;
        }

        // Função para carregar mensagens via AJAX (polling)
        async function carregarMensagens() {
            try {
                // Usar a página atual para verificar se há novas mensagens (mais confiável que API direta)
                const response = await fetch(window.location.href, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/html'
                    }
                });
                
                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const novasInteracoes = doc.querySelectorAll('.message[data-interacao-id]');
                    
                    // Verificar se há novas mensagens comparando IDs
                    let novaUltimaInteracaoId = 0;
                    novasInteracoes.forEach(el => {
                        const interacaoId = el.getAttribute('data-interacao-id');
                        if (interacaoId) {
                            const id = parseInt(interacaoId);
                            if (id > novaUltimaInteracaoId) {
                                novaUltimaInteracaoId = id;
                            }
                        }
                    });
                    
                    if (novaUltimaInteracaoId > ultimaInteracaoId) {
                        ultimaInteracaoId = novaUltimaInteracaoId;
                        // Recarregar página para mostrar novas mensagens
                        location.reload();
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar mensagens:', error);
            }
        }

        // Função para atualizar status do chamado (polling)
        async function atualizarStatus() {
            try {
                const response = await fetch(window.location.href);
                if (response.ok) {
                    const html = await response.text();
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const statusBadge = doc.querySelector('.status-badge');
                    
                    @if (!Model.IsTecnico())
                    {
                        <text>
                        const currentStatusBadge = document.querySelector('.status-badge');
                        if (currentStatusBadge && statusBadge) {
                            const novoStatus = statusBadge.textContent.trim();
                            if (currentStatusBadge.textContent.trim() !== novoStatus) {
                                currentStatusBadge.textContent = novoStatus;
                                // Mostrar notificação de mudança de status
                                mostrarNotificacaoStatus(novoStatus);
                            }
                        }
                        </text>
                    }
                }
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
            }
        }

        // Função para mostrar notificação de mudança de status
        function mostrarNotificacaoStatus(novoStatus) {
            // Criar notificação visual
            const notification = document.createElement('div');
            notification.className = 'alert alert-info alert-dismissible fade show position-fixed top-0 end-0 m-3';
            notification.style.zIndex = '9999';
            notification.innerHTML = `
                <strong>Status atualizado!</strong> O status do chamado foi alterado para: <strong>${novoStatus}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(notification);
            
            // Remover após 5 segundos
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        // Função para iniciar polling
        let pollingInterval = null;
        function iniciarPolling() {
            if (!pollingAtivo || chamadoId === 0) return;

            // Limpar intervalo anterior se existir
            if (pollingInterval) {
                clearInterval(pollingInterval);
            }

            // Polling a cada 5 segundos
            pollingInterval = setInterval(async () => {
                if (pollingAtivo) {
                    await carregarMensagens();
                    await atualizarStatus();
                }
            }, 5000);
        }

        // Pausar polling quando estiver alterando status
        document.addEventListener('DOMContentLoaded', function() {
            const selectStatus = document.querySelector('#formAlterarStatus select');
            if (selectStatus) {
                selectStatus.addEventListener('change', function() {
                    // Pausar polling temporariamente durante alteração de status
                    pollingAtivo = false;
                    if (pollingInterval) {
                        clearInterval(pollingInterval);
                    }
                });
            }
        });

        // Pausar polling quando a página não está visível
        document.addEventListener('visibilitychange', function() {
            pollingAtivo = !document.hidden;
        });
    </script>
}

