@page
@model CarTechAssist.Web.Pages.ChatBotModel
@{
    ViewData["Title"] = "ChatBot - CarTechAssist";
}

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-0">
                    <i class="bi bi-robot text-success"></i> ChatBot
                </h1>
                <p class="text-muted">Assistente virtual para atendimento rÃ¡pido</p>
            </div>
            <div>
                <a href="/Dashboard" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Voltar
                </a>
                @if (Model.ChamadoAtualId.HasValue)
                {
                    <a href="/Chamados/Detalhes/@Model.ChamadoAtualId" class="btn btn-primary ms-2">
                        <i class="bi bi-ticket"></i> Ver Chamado
                    </a>
                }
            </div>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @Model.ErrorMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<div class="row">
    <div class="col-12">
        <div class="card" style="height: 70vh; display: flex; flex-direction: column;">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-chat-dots"></i> Conversa com o Assistente Virtual
                </h5>
            </div>
            <div class="card-body" style="flex: 1; overflow-y: auto; background: #1a1a1a; padding: 20px;">
                <div id="chatMessages">
                    @if (Model.Mensagens != null && Model.Mensagens.Any())
                    {
                        @foreach (var msg in Model.Mensagens)
                        {
                            <div class="message mb-3 @(msg.EhBot ? "" : "text-end")">
                                <div class="d-inline-block p-3 rounded" style="background: @(msg.EhBot ? "#282c34" : "#4CAF50"); max-width: 70%; border-radius: 12px;">
                                    <div class="d-flex align-items-center mb-1">
                                        @if (msg.EhBot)
                                        {
                                            <i class="bi bi-robot me-2" style="color: #4CAF50;"></i>
                                            <small class="fw-bold">ChatBot</small>
                                        }
                                        else
                                        {
                                            <i class="bi bi-person-circle me-2"></i>
                                            <small class="fw-bold">VocÃª</small>
                                        }
                                    </div>
                                    <div class="mb-1" style="white-space: pre-wrap; word-wrap: break-word;">
                                        @{
                                            var texto = msg.Mensagem.Replace("\n", "<br/>");
                                            // Substituir **texto** por <strong>texto</strong>
                                            texto = System.Text.RegularExpressions.Regex.Replace(texto, @"\*\*(.+?)\*\*", "<strong>$1</strong>");
                                        }
                                        @Html.Raw(texto)
                                    </div>
                                    <small class="text-muted">@msg.DataCriacao.ToString("HH:mm")</small>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-robot" style="font-size: 3rem; color: #4CAF50;"></i>
                            <p class="mt-3">OlÃ¡! ðŸ‘‹ Sou seu assistente virtual. Como posso ajudÃ¡-lo hoje?</p>
                        </div>
                    }
                </div>
            </div>
            <div class="card-footer">
                <form method="post" id="chatForm">
                    <div class="input-group">
                        <input type="text" 
                               asp-for="NovaMensagem" 
                               class="form-control" 
                               placeholder="Digite sua mensagem..." 
                               autocomplete="off"
                               id="mensagemInput" />
                        <button type="submit" class="btn btn-success">
                            <i class="bi bi-send"></i> Enviar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Auto-scroll para Ãºltima mensagem
        function scrollToBottom() {
            var chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        // Scroll inicial
        document.addEventListener('DOMContentLoaded', function() {
            scrollToBottom();
            
            // Focar no input
            var input = document.getElementById('mensagemInput');
            if (input) {
                input.focus();
            }
        });

        // Scroll apÃ³s envio
        document.getElementById('chatForm')?.addEventListener('submit', function() {
            setTimeout(scrollToBottom, 100);
        });

        // Enter para enviar (exceto Shift+Enter para nova linha)
        document.getElementById('mensagemInput')?.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                document.getElementById('chatForm')?.submit();
            }
        });
    </script>
}

