@page
@model CarTechAssist.Web.Pages.UsuariosModel
@{
    ViewData["Title"] = "Usuários";
}

<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-0">
                    <i class="bi bi-people text-success"></i> Usuários
                </h1>
                <p class="text-muted">Gerencie os usuários do sistema</p>
            </div>
            <div>
                <button type="button" class="btn btn-primary" data-bs-toggle="collapse" data-bs-target="#formUsuario">
                    <i class="bi bi-plus-circle"></i> Novo Usuário
                </button>
            </div>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(Model.SuccessMessage))
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @Model.SuccessMessage
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

@if (!string.IsNullOrEmpty(Model.ErrorMessage))
{
    <div class="alert alert-danger" role="alert">
        @Model.ErrorMessage
    </div>
}

<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="post" class="@(Model.MostrarFormulario ? "" : "collapse")" id="formUsuario">
                    <h5 class="mb-3">Criar Novo Usuário</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="NovoUsuario.Login" class="form-label">Login <span class="text-danger">*</span></label>
                            <input asp-for="NovoUsuario.Login" class="form-control" required maxlength="50" />
                            <span asp-validation-for="NovoUsuario.Login" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="NovoUsuario.NomeCompleto" class="form-label">Nome Completo <span class="text-danger">*</span></label>
                            <input asp-for="NovoUsuario.NomeCompleto" class="form-control" required maxlength="200" />
                            <span asp-validation-for="NovoUsuario.NomeCompleto" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="NovoUsuario.Email" class="form-label">E-mail</label>
                            <input asp-for="NovoUsuario.Email" type="email" class="form-control" maxlength="200" />
                            <span asp-validation-for="NovoUsuario.Email" class="text-danger"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="NovoUsuario.Telefone" class="form-label">Telefone</label>
                            <input asp-for="NovoUsuario.Telefone" class="form-control" maxlength="20" />
                            <span asp-validation-for="NovoUsuario.Telefone" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="NovoUsuario.TipoUsuarioId" class="form-label">Tipo de Usuário <span class="text-danger">*</span></label>
                            <select asp-for="NovoUsuario.TipoUsuarioId" class="form-select" required>
                                <option value="2" selected>Agente</option>
                                <option value="3">Admin</option>
                            </select>
                            <small class="text-muted">Apenas Agente(2) e Admin(3) podem ser criados aqui</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="NovoUsuario.Senha" class="form-label">Senha <span class="text-danger">*</span></label>
                            <input asp-for="NovoUsuario.Senha" type="password" class="form-control" required minlength="6" />
                            <span asp-validation-for="NovoUsuario.Senha" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="d-flex justify-content-end">
                        <button type="button" class="btn btn-secondary me-2" data-bs-toggle="collapse" data-bs-target="#formUsuario">Cancelar</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle"></i> Criar Usuário
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Filtros</h5>
                    <div>
                        <a href="/Usuarios" class="btn btn-sm btn-outline-secondary">Limpar</a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <form method="get" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Tipo de Usuário</label>
                        <select name="tipo" class="form-select">
                            <option value="">Todos</option>
                            <option value="1" selected="@(Model.TipoFiltro == 1)">Cliente</option>
                            <option value="2" selected="@(Model.TipoFiltro == 2)">Agente</option>
                            <option value="3" selected="@(Model.TipoFiltro == 3)">Admin</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-funnel"></i> Filtrar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Lista de Usuários</h5>
            </div>
            <div class="card-body">
                @if (Model.Usuarios?.Items != null && Model.Usuarios.Items.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Login</th>
                                    <th>Nome Completo</th>
                                    <th>E-mail</th>
                                    <th>Telefone</th>
                                    <th>Tipo</th>
                                    <th>Status</th>
                                    <th>Data Criação</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var usuario in Model.Usuarios.Items)
                                {
                                    <tr>
                                        <td><strong>@usuario.Login</strong></td>
                                        <td>@usuario.NomeCompleto</td>
                                        <td>@(usuario.Email ?? "-")</td>
                                        <td>@(usuario.Telefone ?? "-")</td>
                                        <td>
                                            <span class="badge @Model.GetTipoUsuarioBadgeClass(usuario.TipoUsuarioId)">
                                                @Model.GetTipoUsuarioNome(usuario.TipoUsuarioId)
                                            </span>
                                        </td>
                                        <td>
                                            @if (usuario.Ativo)
                                            {
                                                <span class="badge bg-success">Ativo</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">Inativo</span>
                                            }
                                        </td>
                                        <td>@usuario.DataCriacao.ToString("dd/MM/yyyy HH:mm")</td>
                                        <td class="d-flex gap-2">
                                            <!-- Botão Editar abre modal com dados -->
                                            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#modalEditar"
                                                    data-id="@usuario.UsuarioId" data-nome="@usuario.NomeCompleto" data-email="@usuario.Email" data-telefone="@usuario.Telefone" data-tipo="@usuario.TipoUsuarioId">
                                                <i class="bi bi-pencil"></i>
                                            </button>

                                            <!-- Alternar Ativo/Inativo -->
                                            <form method="post" asp-page-handler="ToggleAtivo" class="d-inline">
                                                <input type="hidden" name="usuarioId" value="@usuario.UsuarioId" />
                                                <input type="hidden" name="ativoAtual" value="@usuario.Ativo" />
                                                <button type="submit" 
                                                        class="btn btn-sm @(usuario.Ativo ? "btn-outline-warning" : "btn-outline-success")"
                                                        title="@(usuario.Ativo ? "Desativar usuário" : "Ativar usuário")"
                                                        onclick="return confirm('Tem certeza que deseja @(usuario.Ativo ? "desativar" : "ativar") o usuário @usuario.NomeCompleto?');">
                                                    <i class="bi @(usuario.Ativo ? "bi-person-dash" : "bi-person-check")"></i>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    @if (Model.Usuarios != null)
                    {
                        var totalPages = Model.GetTotalPages();
                        @if (totalPages > 1)
                    {
                        <nav aria-label="Paginação">
                            <ul class="pagination justify-content-center">
                                @if (Model.CurrentPage > 1)
                                {
                                    <li class="page-item">
                                        <a class="page-link" href="?page=@(Model.CurrentPage - 1)&tipo=@Model.TipoFiltro">Anterior</a>
                                    </li>
                                }

                                @for (int i = 1; i <= totalPages; i++)
                                {
                                    <li class="page-item @(i == Model.CurrentPage ? "active" : "")">
                                        <a class="page-link" href="?page=@i&tipo=@Model.TipoFiltro">@i</a>
                                    </li>
                                }

                                @if (Model.CurrentPage < totalPages)
                                {
                                    <li class="page-item">
                                        <a class="page-link" href="?page=@(Model.CurrentPage + 1)&tipo=@Model.TipoFiltro">Próxima</a>
                                    </li>
                                }
                            </ul>
                        </nav>
                        }
                    }
                }
                else
                {
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Nenhum usuário encontrado.
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Usuário -->
<div class="modal fade" id="modalEditar" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil-square"></i> Editar Usuário</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" asp-page-handler="Editar">
        <div class="modal-body">
            <input type="hidden" asp-for="EditUsuarioId" id="editUsuarioId" />
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Nome Completo</label>
                    <input asp-for="EditUsuario.NomeCompleto" class="form-control" id="editNome" required maxlength="200" />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">E-mail</label>
                    <input asp-for="EditUsuario.Email" class="form-control" id="editEmail" type="email" maxlength="200" />
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Telefone</label>
                    <input asp-for="EditUsuario.Telefone" class="form-control" id="editTelefone" maxlength="20" />
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Tipo de Usuário</label>
                    <select asp-for="EditUsuario.TipoUsuarioId" class="form-select" id="editTipo">
                        <option value="2">Agente</option>
                        <option value="3">Admin</option>
                    </select>
                </div>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary"><i class="bi bi-check-circle"></i> Salvar</button>
        </div>
      </form>
    </div>
  </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        const modalEditar = document.getElementById('modalEditar');
        if (modalEditar) {
            modalEditar.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                if (!button) return;
                const id = button.getAttribute('data-id');
                const nome = button.getAttribute('data-nome');
                const email = button.getAttribute('data-email');
                const telefone = button.getAttribute('data-telefone');
                const tipo = button.getAttribute('data-tipo');

                document.getElementById('editUsuarioId').value = id;
                document.getElementById('editNome').value = nome ?? '';
                document.getElementById('editEmail').value = email ?? '';
                document.getElementById('editTelefone').value = telefone ?? '';
                document.getElementById('editTipo').value = tipo ?? '2';
            });
        }
    </script>
}

